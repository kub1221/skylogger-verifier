<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Sky Logger â€” Firestoreç…§åˆãƒ“ãƒ¥ãƒ¼</title>
<style>
  body {
    background-color: #111;
    color: #eee;
    font-family: monospace;
    margin: 40px;
  }
  h1 { color: #ffcc00; }
  pre {
    background: #222;
    padding: 16px;
    border-radius: 6px;
    overflow-x: auto;
  }
  .match { color: #0f0; font-weight: bold; }
  .mismatch { color: #f33; font-weight: bold; }
</style>
</head>
<body>
<h1>â˜ï¸ Sky Logger â€” Firestoreç…§åˆãƒ“ãƒ¥ãƒ¼</h1>
<p>Firestoreã¨GitHubã®ãƒ­ã‚°ã‚’è‡ªå‹•ç…§åˆã—ã¾ã™ã€‚</p>

<div id="output">èª­ã¿è¾¼ã¿ä¸­...</div>

<script type="module">
  // ğŸ”¹ Firebase SDK ã‚’èª­ã¿è¾¼ã¿
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // âœ… ã‚ãªãŸã® Sky Logger ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyA_5A6NejCXULUaVpvSLvZJjg7KczEovzA",
    authDomain: "sky-logger-appv1.firebaseapp.com",
    projectId: "sky-logger-appv1",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const output = document.getElementById('output');

  async function loadAndCompare() {
    try {
      // ğŸ”¸ Firestoreã‹ã‚‰æœ€æ–°ãƒ­ã‚°ã‚’1ä»¶å–å¾—
      const q = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(1));
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        output.textContent = "Firestoreã«ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }

      const firestoreData = snapshot.docs[0].data();

      // ğŸ”¸ GitHubä¸Šã® ledger.json ã‚’å–å¾—
      const res = await fetch("https://raw.githubusercontent.com/kub1221/sky-logger-hashes/main/hashes/ledger.json");
      if (!res.ok) {
        throw new Error("GitHub ledger.json ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      const githubData = await res.json();
      const latestGithub = githubData[githubData.length - 1];

      // ğŸ”¸ åŒæ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒ
      const sameId = firestoreData.videoId === latestGithub.videoId;
      const sameAddress = firestoreData.address === latestGithub.address;
      const sameTime =
        Math.abs(
          new Date(firestoreData.createdAt).getTime() -
          new Date(latestGithub.createdAt).getTime()
        ) < 10000; // Â±10ç§’ä»¥å†…ãªã‚‰åŒä¸€ã¨ã¿ãªã™

      const allMatch = sameId && sameAddress && sameTime;

      // ğŸ”¸ çµæœã‚’è¡¨ç¤º
      output.innerHTML = `
        <h3>Firestore æœ€æ–°ãƒ­ã‚°</h3>
        <pre>${JSON.stringify(firestoreData, null, 2)}</pre>
        <h3>GitHub å…¬é–‹å°å¸³</h3>
        <pre>${JSON.stringify(latestGithub, null, 2)}</pre>
        <h3>ç…§åˆçµæœï¼š</h3>
        <p class="${allMatch ? 'match' : 'mismatch'}">
          ${allMatch ? 'âœ… ä¸€è‡´ã—ã¾ã—ãŸï¼ˆæ”¹ã–ã‚“ãªã—ï¼‰' : 'âš ï¸ ä¸ä¸€è‡´ã§ã™ï¼ˆè¦ç¢ºèªï¼‰'}
        </p>
      `;
    } catch (err) {
      console.error(err);
      output.textContent = `èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}`;
    }
  }

  loadAndCompare();
</script>
</body>
</html>
