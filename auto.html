<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sky Logger – Auto Verifier</title>
<style>
  body{background:#111;color:#fff;font-family:system-ui,sans-serif;padding:24px}
  h1{color:#7ec8ff;font-size:22px;margin:0 0 16px}
  .card{background:#1c1c1c;border-radius:12px;padding:16px;box-shadow:0 0 16px rgba(0,0,0,.35)}
  .row{margin:10px 0}
  .key{color:#7ec8ff;font-weight:bold}
  .pass{color:#2ecc71;font-weight:bold}
  .fail{color:#ff7675;font-weight:bold}
  .note{color:#9aa;font-size:12px}
</style>
</head>
<body>
  <h1>📸 Sky Logger – Auto Verifier</h1>

  <div class="card">
    <div class="row"><b>① 映像またはスクリーンショットを選択：</b></div>
    <input id="file" type="file" accept="image/*,video/*">
    <video id="vid" controls style="display:none"></video>
    <canvas id="snap" style="display:none"></canvas>

    <div class="row"><b>② QRコードの解析結果：</b></div>
    <div id="out">(未解析)</div>

    <div class="row"><b>③ GitHubの記録との照合結果：</b> <span id="verifyResult">—</span></div>
    <div class="note">※ GitHub上のハッシュと一致すれば「PASS」になります。</div>
  </div>

<!-- ✅ ZXingライブラリ UMD版（確実動作・Safari対応） -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {

  console.log("ZXing initialized:", typeof ZXing !== "undefined");
  const codeReader = new ZXing.BrowserQRCodeReader();

  // ==== GitHub設定 ====
  const OWNER  = "kub1221";
  const REPO   = "sky-logger-hashes";
  const BRANCH = "main";

  // ==== 要素参照 ====
  const fileInput = document.getElementById('file');
  const out = document.getElementById('out');
  const verifyResult = document.getElementById('verifyResult');
  const vid = document.getElementById('vid');
  const snap = document.getElementById('snap');

  // ==== QRパラメータ解析 ====
  function parseQRParams(text){
    try{
      const u = new URL(text);
      const p = u.searchParams;
      return {
        uuid: p.get('uuid'),
        lat:  p.get('lat'),
        lng:  p.get('lng'),
        capturedAt: p.get('capturedAt'),
        file: p.get('file'),
        hash: p.get('hash'),
        _raw: text
      };
    }catch{
      const q = new URLSearchParams(text.split('?')[1] || text);
      return {
        uuid: q.get('uuid'),
        lat:  q.get('lat'),
        lng:  q.get('lng'),
        capturedAt: q.get('capturedAt'),
        file: q.get('file'),
        hash: q.get('hash'),
        _raw: text
      };
    }
  }

  // ==== GitHubハッシュ照合 ====
  async function verifyOnGitHub(fileName, qrHash){
    if (!fileName || !qrHash) return {ok:false, reason:"file/hash 不足"};

    const m = fileName.match(/_([0-9a-f-]{36})\.json$/i);
    if(!m) return {ok:false, reason:"videoId抽出失敗"};
    const videoId = m[1];

    const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/hashes/${videoId}.txt`;
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) return {ok:false, reason:`GitHub応答エラー (${res.status})`};
      const text = (await res.text()).trim();
      const ok = text.includes(qrHash);
      return {ok, reason: ok ? "一致" : "不一致", videoId, remote:text};
    }catch(e){
      return {ok:false, reason:"GitHub取得失敗: "+e};
    }
  }

  // ==== QR解析（画像/動画対応） ====
  async function decodeFromFile(f){
    if(f.type.startsWith('video/')){
      return new Promise((resolve, reject)=>{
        vid.src = URL.createObjectURL(f);
        vid.onloadeddata = ()=>{
          vid.currentTime = vid.duration * 0.1;
        };
        vid.onseeked = ()=>{
          const w=vid.videoWidth,h=vid.videoHeight;
          snap.width=w;snap.height=h;
          const ctx=snap.getContext('2d');
          ctx.drawImage(vid,0,0,w,h);
          snap.toBlob(async blob=>{
            try{
              const res=await codeReader.decodeFromImageUrl(URL.createObjectURL(blob));
              resolve(res.getText());
            }catch(e){reject(e);}
          });
        };
      });
    }else{
      const url = URL.createObjectURL(f);
      const result = await codeReader.decodeFromImageUrl(url);
      URL.revokeObjectURL(url);
      return result.getText();
    }
  }

  // ==== メイン処理 ====
  fileInput.addEventListener('change', async ev=>{
    const f = ev.target.files?.[0];
    if(!f){ out.textContent="ファイル未選択"; return; }

    out.textContent="解析中…"; verifyResult.textContent="—";

    try{
      const qrText = await decodeFromFile(f);
      const p = parseQRParams(qrText);
      out.innerHTML = `
        <div><span class="key">UUID:</span> ${p.uuid}</div>
        <div><span class="key">位置:</span> ${p.lat}, ${p.lng}</div>
        <div><span class="key">撮影日時:</span> ${p.capturedAt}</div>
        <div><span class="key">ファイル:</span> ${p.file}</div>
        <div><span class="key">ハッシュ:</span> ${p.hash}</div>
      `;
      const v = await verifyOnGitHub(p.file, p.hash);
      verifyResult.innerHTML = v.ok
        ? `<span class="pass">✅ PASS</span>（GitHub記録と一致）`
        : `<span class="fail">❌ FAIL</span>（${v.reason}）`;
    }catch(e){
      console.error(e);
      out.innerHTML = `<span class="fail">QR解析に失敗:</span> ${String(e)}`;
    }
  });

});
</script>
</body>
</html>
