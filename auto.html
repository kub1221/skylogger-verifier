<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sky Logger – Auto Verifier</title>
<style>
  body{background:#111;color:#fff;font-family:system-ui,sans-serif;padding:24px}
  h1{color:#7ec8ff;font-size:22px;margin:0 0 16px}
  .card{background:#1c1c1c;border-radius:12px;padding:16px;box-shadow:0 0 16px rgba(0,0,0,.35)}
  .row{margin:10px 0}
  .key{color:#7ec8ff;font-weight:bold}
  .pass{color:#2ecc71;font-weight:bold}
  .fail{color:#ff7675;font-weight:bold}
  .note{color:#9aa;font-size:12px}
  input[type=file]{display:block;margin:12px 0}
  video,canvas{max-width:100%;display:block;margin-top:8px}
</style>
</head>
<body>
  <h1>📸 Sky Logger – Auto Verifier</h1>

  <div class="card">
    <div class="row"><b>① 映像またはスクリーンショットを選択：</b></div>
    <input id="file" type="file" accept="image/*,video/*" />
    <video id="vid" controls style="display:none"></video>
    <canvas id="snap" style="display:none"></canvas>

    <div class="row"><b>② QRコードの解析結果：</b></div>
    <div id="out">(未解析)</div>

    <div class="row"><b>③ GitHubの記録との照合結果：</b> <span id="verifyResult">—</span></div>
    <div class="note">※ GitHub上のハッシュと一致すれば「PASS」になります。</div>
  </div>

<!-- ✅ ZXing 正しいCDN定義 -->
<script src="https://unpkg.com/@zxing/library@0.19.1"></script>
<script>
const codeReader = new ZXing.BrowserQRCodeReader();

// ==== 基本設定 ====
const OWNER  = "kub1221";
const REPO   = "skylogger-verifier-data";
const BRANCH = "main";

// ==== 要素参照 ====
const fileInput = document.getElementById('file');
const out = document.getElementById('out');
const verifyResult = document.getElementById('verifyResult');
const vid = document.getElementById('vid');
const snap = document.getElementById('snap');

// ==== JST変換 ====
function toJST(iso){
  try{
    const d = new Date(iso);
    const j = new Date(d.getTime() + 9*3600*1000);
    const pad = n=>String(n).padStart(2,'0');
    return `${j.getFullYear()}/${pad(j.getMonth()+1)}/${pad(j.getDate())} ${pad(j.getHours())}:${pad(j.getMinutes())}:${pad(j.getSeconds())} (JST)`;
  }catch{ return "(変換できません)"; }
}

// ==== QRパラメータ解析 ====
function parseQRParams(text){
  try{
    const u = new URL(text);
    const p = u.searchParams;
    return {
      uuid: p.get('uuid'),
      lat:  p.get('lat'),
      lng:  p.get('lng'),
      capturedAt: p.get('capturedAt'),
      file: p.get('file'),
      hash: p.get('hash'),
      _raw: text
    };
  }catch{
    const idx = text.indexOf('?');
    const q = new URLSearchParams(idx>=0 ? text.slice(idx+1) : text);
    return {
      uuid: q.get('uuid'),
      lat:  q.get('lat'),
      lng:  q.get('lng'),
      capturedAt: q.get('capturedAt'),
      file: q.get('file'),
      hash: q.get('hash'),
      _raw: text
    };
  }
}

// ==== GitHubとの照合 ====
async function verifyOnGitHub(fileName, qrHash){
  if (!fileName || !qrHash) return {ok:false, reason:"file/hash 不足"};

  const m = fileName.match(/_([0-9a-f-]{36})\.json$/i);
  if(!m) return {ok:false, reason:"videoId 抽出失敗"};
  const videoId = m[1];

  const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/hashes/${videoId}.txt`;
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) return {ok:false, reason:`GitHub 404/NG (${res.status})`};
    const text = (await res.text()).trim();
    const ok = text === qrHash || text.split(/\s+/).includes(qrHash);
    return {ok, reason: ok ? "一致" : "不一致", videoId, remote:text};
  }catch(e){
    return {ok:false, reason:"GitHub fetch 失敗: "+e};
  }
}

// ==== QR解析（画像） ====
async function decodeFromImage(blob){
  const imgUrl = URL.createObjectURL(blob);
  const result = await codeReader.decodeFromImageUrl(imgUrl);
  URL.revokeObjectURL(imgUrl);
  return result.getText();
}

// ==== QR解析（動画） ====
async function decodeFromVideo(blob){
  return new Promise((resolve, reject)=>{
    vid.src = URL.createObjectURL(blob);
    vid.style.display = 'block';
    vid.onloadeddata = ()=>{
      vid.currentTime = Math.min(1.0, (vid.duration || 1) * 0.1);
    };
    vid.onseeked = ()=>{
      const w = vid.videoWidth, h = vid.videoHeight;
      if(!w || !h) return reject('動画寸法なし');
      snap.width = w; snap.height = h;
      const ctx = snap.getContext('2d');
      ctx.drawImage(vid, 0, 0, w, h);
      snap.toBlob(async (frameBlob)=>{
        try{
          const url = URL.createObjectURL(frameBlob);
          const res = await codeReader.decodeFromImageUrl(url);
          URL.revokeObjectURL(url);
          resolve(res.getText());
        }catch(e){ reject(e); }
      }, 'image/png');
    };
    vid.onerror = e=>reject(e);
  });
}

// ==== メイン処理 ====
fileInput.addEventListener('change', async (ev)=>{
  out.textContent = '解析中…';
  verifyResult.textContent = '—';
  const f = ev.target.files?.[0];
  if(!f){ out.textContent='ファイル未選択'; return; }

  try{
    let qrText;
    if(f.type.startsWith('video/')){
      qrText = await decodeFromVideo(f);
    }else{
      qrText = await decodeFromImage(f);
    }

    const p = parseQRParams(qrText);
    if(!p.uuid){ out.innerHTML = `<span class="fail">QRに必要項目がありません</span><br>${qrText}`; return; }

    const jst = toJST(p.capturedAt);
    out.innerHTML = `
      <div><span class="key">UUID:</span> ${p.uuid}</div>
      <div><span class="key">位置情報:</span> ${p.lat}, ${p.lng}</div>
      <div><span class="key">撮影日時(UTC):</span> ${p.capturedAt || '(未指定)'}</div>
      <div><span class="key">撮影日時(JST):</span> ${jst}</div>
      <div><span class="key">ファイル名:</span> ${p.file || '(不明)'}</div>
      <div><span class="key">ハッシュ:</span> ${p.hash || '(不明)'}</div>
      <div class="row"><a target="_blank" href="https://www.google.com/maps?q=${p.lat},${p.lng}">🌍 Googleマップで開く</a></div>
      <div class="note">※ GitHub上のハッシュ照合を実施中...</div>
    `;

    const v = await verifyOnGitHub(p.file, p.hash);
    verifyResult.innerHTML = v.ok
      ? `<span class="pass">✅ PASS</span>（GitHub記録と一致）`
      : `<span class="fail">❌ FAIL</span>（${v.reason}）`;

  }catch(e){
    out.innerHTML = `<span class="fail">QR解析に失敗:</span> ${String(e)}`;
  }
});
</script>
</body>
</html>
