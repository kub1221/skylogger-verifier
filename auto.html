<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sky Logger â€“ Auto Verifier</title>
<style>
  body{background:#111;color:#fff;font-family:system-ui,sans-serif;padding:24px}
  h1{color:#7ec8ff;font-size:22px;margin:0 0 16px}
  .card{background:#1c1c1c;border-radius:12px;padding:16px;box-shadow:0 0 16px rgba(0,0,0,.35)}
  .row{margin:10px 0}
  .key{color:#7ec8ff;font-weight:bold}
  .pass{color:#2ecc71;font-weight:bold}
  .fail{color:#ff7675;font-weight:bold}
  .note{color:#9aa;font-size:12px}
</style>
</head>
<body>
  <h1>ğŸ“¸ Sky Logger â€“ Auto Verifier</h1>

  <div class="card">
    <div class="row"><b>â‘  æ˜ åƒã¾ãŸã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’é¸æŠï¼š</b></div>
    <input id="file" type="file" accept="image/*,video/*">
    <video id="vid" controls style="display:none"></video>
    <canvas id="snap" style="display:none"></canvas>

    <div class="row"><b>â‘¡ QRã‚³ãƒ¼ãƒ‰ã®è§£æçµæœï¼š</b></div>
    <div id="out">(æœªè§£æ)</div>

    <div class="row"><b>â‘¢ GitHubã®è¨˜éŒ²ã¨ã®ç…§åˆçµæœï¼š</b> <span id="verifyResult">â€”</span></div>
    <div class="note">â€» GitHubä¸Šã®ãƒãƒƒã‚·ãƒ¥ã¨ä¸€è‡´ã™ã‚Œã°ã€ŒPASSã€ã«ãªã‚Šã¾ã™ã€‚</div>
  </div>

<!-- âœ… ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒª UMDç‰ˆï¼ˆç¢ºå®Ÿå‹•ä½œãƒ»Safariå¯¾å¿œï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {

  console.log("ZXing initialized:", typeof ZXing !== "undefined");
  const codeReader = new ZXing.BrowserQRCodeReader();

  // ==== GitHubè¨­å®š ====
  const OWNER  = "kub1221";
  const REPO   = "sky-logger-hashes";
  const BRANCH = "main";

  // ==== è¦ç´ å‚ç…§ ====
  const fileInput = document.getElementById('file');
  const out = document.getElementById('out');
  const verifyResult = document.getElementById('verifyResult');
  const vid = document.getElementById('vid');
  const snap = document.getElementById('snap');

  // ==== QRãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ ====
  function parseQRParams(text){
    try{
      const u = new URL(text);
      const p = u.searchParams;
      return {
        uuid: p.get('uuid'),
        lat:  p.get('lat'),
        lng:  p.get('lng'),
        capturedAt: p.get('capturedAt'),
        file: p.get('file'),
        hash: p.get('hash'),
        _raw: text
      };
    }catch{
      const q = new URLSearchParams(text.split('?')[1] || text);
      return {
        uuid: q.get('uuid'),
        lat:  q.get('lat'),
        lng:  q.get('lng'),
        capturedAt: q.get('capturedAt'),
        file: q.get('file'),
        hash: q.get('hash'),
        _raw: text
      };
    }
  }

  // ==== GitHubãƒãƒƒã‚·ãƒ¥ç…§åˆ ====
  async function verifyOnGitHub(fileName, qrHash){
    if (!fileName || !qrHash) return {ok:false, reason:"file/hash ä¸è¶³"};

    const m = fileName.match(/_([0-9a-f-]{36})\.json$/i);
    if(!m) return {ok:false, reason:"videoIdæŠ½å‡ºå¤±æ•—"};
    const videoId = m[1];

    const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/hashes/${videoId}.txt`;
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) return {ok:false, reason:`GitHubå¿œç­”ã‚¨ãƒ©ãƒ¼ (${res.status})`};
      const text = (await res.text()).trim();
      const ok = text.includes(qrHash);
      return {ok, reason: ok ? "ä¸€è‡´" : "ä¸ä¸€è‡´", videoId, remote:text};
    }catch(e){
      return {ok:false, reason:"GitHubå–å¾—å¤±æ•—: "+e};
    }
  }

  // ==== QRè§£æï¼ˆç”»åƒ/å‹•ç”»å¯¾å¿œï¼‰ ====
  async function decodeFromFile(f){
    if(f.type.startsWith('video/')){
      return new Promise((resolve, reject)=>{
        vid.src = URL.createObjectURL(f);
        vid.onloadeddata = ()=>{
          vid.currentTime = vid.duration * 0.1;
        };
        vid.onseeked = ()=>{
          const w=vid.videoWidth,h=vid.videoHeight;
          snap.width=w;snap.height=h;
          const ctx=snap.getContext('2d');
          ctx.drawImage(vid,0,0,w,h);
          snap.toBlob(async blob=>{
            try{
              const res=await codeReader.decodeFromImageUrl(URL.createObjectURL(blob));
              resolve(res.getText());
            }catch(e){reject(e);}
          });
        };
      });
    }else{
      const url = URL.createObjectURL(f);
      const result = await codeReader.decodeFromImageUrl(url);
      URL.revokeObjectURL(url);
      return result.getText();
    }
  }

  // ==== ãƒ¡ã‚¤ãƒ³å‡¦ç† ====
  fileInput.addEventListener('change', async ev=>{
    const f = ev.target.files?.[0];
    if(!f){ out.textContent="ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ"; return; }

    out.textContent="è§£æä¸­â€¦"; verifyResult.textContent="â€”";

    try{
      const qrText = await decodeFromFile(f);
      const p = parseQRParams(qrText);
      out.innerHTML = `
        <div><span class="key">UUID:</span> ${p.uuid}</div>
        <div><span class="key">ä½ç½®:</span> ${p.lat}, ${p.lng}</div>
        <div><span class="key">æ’®å½±æ—¥æ™‚:</span> ${p.capturedAt}</div>
        <div><span class="key">ãƒ•ã‚¡ã‚¤ãƒ«:</span> ${p.file}</div>
        <div><span class="key">ãƒãƒƒã‚·ãƒ¥:</span> ${p.hash}</div>
      `;
      const v = await verifyOnGitHub(p.file, p.hash);
      verifyResult.innerHTML = v.ok
        ? `<span class="pass">âœ… PASS</span>ï¼ˆGitHubè¨˜éŒ²ã¨ä¸€è‡´ï¼‰`
        : `<span class="fail">âŒ FAIL</span>ï¼ˆ${v.reason}ï¼‰`;
    }catch(e){
      console.error(e);
      out.innerHTML = `<span class="fail">QRè§£æã«å¤±æ•—:</span> ${String(e)}`;
    }
  });

});
</script>
</body>
</html>
