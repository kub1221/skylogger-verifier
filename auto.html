<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sky Logger â€“ Auto Verifier</title>
<style>
  body{background:#111;color:#fff;font-family:system-ui,sans-serif;padding:24px}
  h1{color:#7ec8ff;font-size:22px;margin:0 0 16px}
  .card{background:#1c1c1c;border-radius:12px;padding:16px;box-shadow:0 0 16px rgba(0,0,0,.35)}
  .row{margin:10px 0}
  .key{color:#7ec8ff;font-weight:bold}
  .pass{color:#2ecc71;font-weight:bold}
  .fail{color:#ff7675;font-weight:bold}
  .note{color:#9aa;font-size:12px}
  input[type=file]{display:block;margin:12px 0}
  video,canvas{max-width:100%;display:block;margin-top:8px}
</style>
</head>
<body>
  <h1>ğŸ“¸ Sky Logger â€“ Auto Verifier</h1>

  <div class="card">
    <div class="row"><b>â‘  æ˜ åƒã¾ãŸã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’é¸æŠï¼š</b></div>
    <input id="file" type="file" accept="image/*,video/*" />
    <video id="vid" controls style="display:none"></video>
    <canvas id="snap" style="display:none"></canvas>

    <div class="row"><b>â‘¡ QRã‚³ãƒ¼ãƒ‰ã®è§£æçµæœï¼š</b></div>
    <div id="out">(æœªè§£æ)</div>

    <div class="row"><b>â‘¢ GitHubã®è¨˜éŒ²ã¨ã®ç…§åˆçµæœï¼š</b> <span id="verifyResult">â€”</span></div>
    <div class="note">â€» GitHubä¸Šã®ãƒãƒƒã‚·ãƒ¥ã¨ä¸€è‡´ã™ã‚Œã°ã€ŒPASSã€ã«ãªã‚Šã¾ã™ã€‚</div>
  </div>

<!-- âœ… ZXing æ­£ã—ã„CDNå®šç¾© -->
<script src="https://unpkg.com/@zxing/library@0.19.1"></script>
<script>
const codeReader = new ZXing.BrowserQRCodeReader();

// ==== åŸºæœ¬è¨­å®š ====
const OWNER  = "kub1221";
const REPO   = "skylogger-verifier-data";
const BRANCH = "main";

// ==== è¦ç´ å‚ç…§ ====
const fileInput = document.getElementById('file');
const out = document.getElementById('out');
const verifyResult = document.getElementById('verifyResult');
const vid = document.getElementById('vid');
const snap = document.getElementById('snap');

// ==== JSTå¤‰æ› ====
function toJST(iso){
  try{
    const d = new Date(iso);
    const j = new Date(d.getTime() + 9*3600*1000);
    const pad = n=>String(n).padStart(2,'0');
    return `${j.getFullYear()}/${pad(j.getMonth()+1)}/${pad(j.getDate())} ${pad(j.getHours())}:${pad(j.getMinutes())}:${pad(j.getSeconds())} (JST)`;
  }catch{ return "(å¤‰æ›ã§ãã¾ã›ã‚“)"; }
}

// ==== QRãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ ====
function parseQRParams(text){
  try{
    const u = new URL(text);
    const p = u.searchParams;
    return {
      uuid: p.get('uuid'),
      lat:  p.get('lat'),
      lng:  p.get('lng'),
      capturedAt: p.get('capturedAt'),
      file: p.get('file'),
      hash: p.get('hash'),
      _raw: text
    };
  }catch{
    const idx = text.indexOf('?');
    const q = new URLSearchParams(idx>=0 ? text.slice(idx+1) : text);
    return {
      uuid: q.get('uuid'),
      lat:  q.get('lat'),
      lng:  q.get('lng'),
      capturedAt: q.get('capturedAt'),
      file: q.get('file'),
      hash: q.get('hash'),
      _raw: text
    };
  }
}

// ==== GitHubã¨ã®ç…§åˆ ====
async function verifyOnGitHub(fileName, qrHash){
  if (!fileName || !qrHash) return {ok:false, reason:"file/hash ä¸è¶³"};

  const m = fileName.match(/_([0-9a-f-]{36})\.json$/i);
  if(!m) return {ok:false, reason:"videoId æŠ½å‡ºå¤±æ•—"};
  const videoId = m[1];

  const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/hashes/${videoId}.txt`;
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) return {ok:false, reason:`GitHub 404/NG (${res.status})`};
    const text = (await res.text()).trim();
    const ok = text === qrHash || text.split(/\s+/).includes(qrHash);
    return {ok, reason: ok ? "ä¸€è‡´" : "ä¸ä¸€è‡´", videoId, remote:text};
  }catch(e){
    return {ok:false, reason:"GitHub fetch å¤±æ•—: "+e};
  }
}

// ==== QRè§£æï¼ˆç”»åƒï¼‰ ====
async function decodeFromImage(blob){
  const imgUrl = URL.createObjectURL(blob);
  const result = await codeReader.decodeFromImageUrl(imgUrl);
  URL.revokeObjectURL(imgUrl);
  return result.getText();
}

// ==== QRè§£æï¼ˆå‹•ç”»ï¼‰ ====
async function decodeFromVideo(blob){
  return new Promise((resolve, reject)=>{
    vid.src = URL.createObjectURL(blob);
    vid.style.display = 'block';
    vid.onloadeddata = ()=>{
      vid.currentTime = Math.min(1.0, (vid.duration || 1) * 0.1);
    };
    vid.onseeked = ()=>{
      const w = vid.videoWidth, h = vid.videoHeight;
      if(!w || !h) return reject('å‹•ç”»å¯¸æ³•ãªã—');
      snap.width = w; snap.height = h;
      const ctx = snap.getContext('2d');
      ctx.drawImage(vid, 0, 0, w, h);
      snap.toBlob(async (frameBlob)=>{
        try{
          const url = URL.createObjectURL(frameBlob);
          const res = await codeReader.decodeFromImageUrl(url);
          URL.revokeObjectURL(url);
          resolve(res.getText());
        }catch(e){ reject(e); }
      }, 'image/png');
    };
    vid.onerror = e=>reject(e);
  });
}

// ==== ãƒ¡ã‚¤ãƒ³å‡¦ç† ====
fileInput.addEventListener('change', async (ev)=>{
  out.textContent = 'è§£æä¸­â€¦';
  verifyResult.textContent = 'â€”';
  const f = ev.target.files?.[0];
  if(!f){ out.textContent='ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ'; return; }

  try{
    let qrText;
    if(f.type.startsWith('video/')){
      qrText = await decodeFromVideo(f);
    }else{
      qrText = await decodeFromImage(f);
    }

    const p = parseQRParams(qrText);
    if(!p.uuid){ out.innerHTML = `<span class="fail">QRã«å¿…è¦é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</span><br>${qrText}`; return; }

    const jst = toJST(p.capturedAt);
    out.innerHTML = `
      <div><span class="key">UUID:</span> ${p.uuid}</div>
      <div><span class="key">ä½ç½®æƒ…å ±:</span> ${p.lat}, ${p.lng}</div>
      <div><span class="key">æ’®å½±æ—¥æ™‚(UTC):</span> ${p.capturedAt || '(æœªæŒ‡å®š)'}</div>
      <div><span class="key">æ’®å½±æ—¥æ™‚(JST):</span> ${jst}</div>
      <div><span class="key">ãƒ•ã‚¡ã‚¤ãƒ«å:</span> ${p.file || '(ä¸æ˜)'}</div>
      <div><span class="key">ãƒãƒƒã‚·ãƒ¥:</span> ${p.hash || '(ä¸æ˜)'}</div>
      <div class="row"><a target="_blank" href="https://www.google.com/maps?q=${p.lat},${p.lng}">ğŸŒ Googleãƒãƒƒãƒ—ã§é–‹ã</a></div>
      <div class="note">â€» GitHubä¸Šã®ãƒãƒƒã‚·ãƒ¥ç…§åˆã‚’å®Ÿæ–½ä¸­...</div>
    `;

    const v = await verifyOnGitHub(p.file, p.hash);
    verifyResult.innerHTML = v.ok
      ? `<span class="pass">âœ… PASS</span>ï¼ˆGitHubè¨˜éŒ²ã¨ä¸€è‡´ï¼‰`
      : `<span class="fail">âŒ FAIL</span>ï¼ˆ${v.reason}ï¼‰`;

  }catch(e){
    out.innerHTML = `<span class="fail">QRè§£æã«å¤±æ•—:</span> ${String(e)}`;
  }
});
</script>
</body>
</html>
