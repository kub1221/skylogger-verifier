<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sky Logger â€“ Debug Verifier (v3)</title>
<style>
  body{background:#111;color:#fff;font-family:system-ui,sans-serif;padding:20px}
  h1{color:#7ec8ff;font-size:22px;margin:0 0 16px}
  .card{background:#1c1c1c;border-radius:12px;padding:16px;box-shadow:0 0 16px rgba(0,0,0,.35)}
  .ok{color:#2ecc71;font-weight:bold}
  .fail{color:#ff7675;font-weight:bold}
  pre{background:#222;padding:10px;border-radius:8px;white-space:pre-wrap}
</style>
</head>
<body>
  <h1>ğŸ” Sky Logger â€“ Debug Verifier (v3)</h1>
  <input id="file" type="file" accept="image/*" />
  <canvas id="canvas" style="max-width:100%;display:block;margin-top:12px"></canvas>
  <div class="card">
    <b>ãƒ­ã‚°å‡ºåŠ›ï¼š</b>
    <pre id="log">(ã“ã“ã«é€²è¡ŒçŠ¶æ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™)</pre>
  </div>

<!-- âœ… jsQRãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
const fileInput = document.getElementById("file");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const log = (msg) => {
  const box = document.getElementById("log");
  box.textContent += msg + "\n";
  console.log(msg);
};

// ==== GitHubè¨­å®š ====
const OWNER  = "kub1221";
const REPO   = "sky-logger-hashes";
const BRANCH = "main";

// ==== GitHubãƒãƒƒã‚·ãƒ¥ç…§åˆ ====
async function verifyOnGitHub(fileName, qrHash){
  if (!fileName || !qrHash) return {ok:false, reason:"file/hash ä¸è¶³"};
  const m = fileName.match(/_([0-9a-f-]{36})\.json$/i);
  if(!m) return {ok:false, reason:"videoIdæŠ½å‡ºå¤±æ•—"};
  const videoId = m[1];
  const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/hashes/${videoId}.txt`;
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) return {ok:false, reason:`GitHubå¿œç­”ã‚¨ãƒ©ãƒ¼ (${res.status})`};
    const text = (await res.text()).trim();
    const ok = text.includes(qrHash);
    return {ok, reason: ok ? "ä¸€è‡´" : "ä¸ä¸€è‡´", videoId, remote:text};
  }catch(e){
    return {ok:false, reason:"GitHubå–å¾—å¤±æ•—: "+e};
  }
}

// ==== QRè§£æ ====
fileInput.addEventListener("change", async (ev)=>{
  const f = ev.target.files?.[0];
  if(!f){ log("âŒ ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ"); return; }

  log(`ğŸ—‚ ãƒ•ã‚¡ã‚¤ãƒ«å: ${f.name}`);
  const img = new Image();
  img.onload = async ()=>{
    log("âœ… ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ");
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    log(`ğŸ§© ç”»åƒã‚µã‚¤ã‚º: ${canvas.width}x${canvas.height}`);

    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if(code){
      log(`âœ… QRè§£ææˆåŠŸ: ${code.data.slice(0,200)}...`);
      try{
        const u = new URL(code.data);
        const p = u.searchParams;
        const file = p.get('file');
        const hash = p.get('hash');
        const v = await verifyOnGitHub(file, hash);
        log(v.ok ? `âœ… GitHubç…§åˆPASS (${v.reason})` : `âŒ GitHubç…§åˆFAIL (${v.reason})`);
      }catch(e){
        log("âš ï¸ QRå†…å®¹è§£æã‚¨ãƒ©ãƒ¼: " + e);
      }
    }else{
      log("âŒ QRè§£æå¤±æ•—ï¼ˆjsQRãŒã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰");
    }
  };
  img.onerror = e => log("âŒ ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: " + e);
  img.src = URL.createObjectURL(f);
});
</script>
</body>
</html>