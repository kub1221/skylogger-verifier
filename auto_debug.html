<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sky Logger â€“ Debug Verifier</title>
<style>
  body{background:#111;color:#fff;font-family:system-ui,sans-serif;padding:24px}
  h1{color:#7ec8ff;font-size:22px;margin:0 0 16px}
  pre{background:#222;padding:10px;border-radius:8px;white-space:pre-wrap}
  .ok{color:#2ecc71}.ng{color:#ff7675}
</style>
</head>
<body>
  <h1>ğŸ§­ Sky Logger â€“ Debug Verifier</h1>
  <input id="file" type="file" accept="image/*,video/*"><br><br>
  <div id="log"><b>ãƒ­ã‚°å‡ºåŠ›ï¼š</b></div>
  <pre id="output">(ã“ã“ã«é€²è¡ŒçŠ¶æ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™)</pre>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {

  const output = document.getElementById('output');
  const fileInput = document.getElementById('file');
  function log(msg){
    console.log(msg);
    output.textContent += msg + "\n";
  }

  log("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†");

  if (typeof ZXing === "undefined") {
    log("âŒ ZXingãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }
  log("âœ… ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œå‡º");

  const codeReader = new ZXing.BrowserQRCodeReader();
  log("âœ… QRãƒªãƒ¼ãƒ€ãƒ¼åˆæœŸåŒ–å®Œäº†");

  fileInput.addEventListener('change', async ev=>{
    const f = ev.target.files?.[0];
    if(!f){ log("âŒ ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ"); return; }
    log(`ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«å: ${f.name}`);
    log(`ğŸ“„ MIMEã‚¿ã‚¤ãƒ—: ${f.type}`);

    try{
      if(f.type.startsWith("video/")){
        log("ğŸ å‹•ç”»ãƒ¢ãƒ¼ãƒ‰: æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰QRã‚’æŠ½å‡ºäºˆå®š");
        const vid = document.createElement("video");
        vid.src = URL.createObjectURL(f);
        vid.onloadeddata = ()=>{
          log(`ğŸ¥ å‹•ç”»ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: duration=${vid.duration}s`);
          vid.currentTime = vid.duration * 0.1;
        };
        vid.onseeked = async ()=>{
          const canvas = document.createElement("canvas");
          canvas.width = vid.videoWidth;
          canvas.height = vid.videoHeight;
          canvas.getContext("2d").drawImage(vid,0,0);
          const blob = await new Promise(r=>canvas.toBlob(r,"image/jpeg"));
          const url = URL.createObjectURL(blob);
          log("ğŸ§© ç”»åƒæŠ½å‡º â†’ ZXingè§£æé–‹å§‹");
          try{
            const result = await codeReader.decodeFromImageUrl(url);
            log(`âœ… QRè§£ææˆåŠŸ: ${result.getText().slice(0,120)}...`);
          }catch(e){
            log(`âŒ QRè§£æå¤±æ•—ï¼ˆå‹•ç”»ï¼‰: ${e}`);
          }
        };
      }else{
        log("ğŸ–¼ é™æ­¢ç”»ãƒ¢ãƒ¼ãƒ‰: ZXingè§£æé–‹å§‹");
        const url = URL.createObjectURL(f);
        try{
          const result = await codeReader.decodeFromImageUrl(url);
          log(`âœ… QRè§£ææˆåŠŸ: ${result.getText().slice(0,120)}...`);
        }catch(e){
          log(`âŒ QRè§£æå¤±æ•—ï¼ˆç”»åƒï¼‰: ${e}`);
        }finally{
          URL.revokeObjectURL(url);
        }
      }
    }catch(e){
      log("âš ï¸ ä¾‹å¤–ç™ºç”Ÿ: "+e);
    }
  });
});
</script>
</body>
</html>