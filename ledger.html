<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ“œ Sky Logger â€“ Public Ledger</title>
<style>
  body { background:#111; color:#fff; font-family:system-ui,sans-serif; padding:24px; }
  h1 { color:#7ec8ff; font-size:22px; margin:0 0 16px; }
  .entry { background:#1c1c1c; border-radius:8px; padding:10px; margin:6px 0; }
  .id { color:#7ec8ff; font-weight:bold; }
  .hash { color:#9aa; font-family:monospace; font-size:12px; margin-top:4px; }
  .meta { font-size:13px; color:#ccc; margin-top:4px; }
  a { color:#7ec8ff; text-decoration:none; }
  a:hover { text-decoration:underline; }
  .fail { color:#ff7675; }
  .note { font-size:12px; color:#999; margin-top:12px; }
</style>
</head>
<body>
  <h1>ğŸ“œ Sky Logger â€“ å…¬é–‹å°å¸³ï¼ˆPublic Ledgerï¼‰</h1>
  <div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>
  <div class="note">â€» GitHubä¸Šã®ç½²åãƒãƒƒã‚·ãƒ¥ã‚’Firestoreãƒ­ã‚°ã¨ç…§åˆã—ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</div>

<script>
const OWNER = "kub1221";
const REPO = "sky-logger-hashes";
const BRANCH = "main";

// Firestoreç”±æ¥ã®JSONã‚’Cloud Functionsã§åŒãƒªãƒã‚¸ãƒˆãƒªã«ç”Ÿæˆã—ã¦ã„ã‚‹æƒ³å®š
const JSON_URL = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/ledger.json`;

async function fetchLedger() {
  const apiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/hashes?ref=${BRANCH}`;
  const listDiv = document.getElementById('list');
  try {
    const [hashRes, logRes] = await Promise.all([
      fetch(apiUrl, { cache: 'no-store' }),
      fetch(JSON_URL, { cache: 'no-store' })
    ]);

    const hashList = await hashRes.json();
    const logs = await logRes.json();

    listDiv.innerHTML = "";

    for (const file of hashList) {
      if (!file.name.endsWith(".txt")) continue;
      const id = file.name.replace(".txt", "");
      const txtUrl = file.download_url;
      const txtRes = await fetch(txtUrl, { cache: 'no-store' });
      const hash = (await txtRes.text()).trim();

      // Firestoreãƒ­ã‚°ã‹ã‚‰ä¸€è‡´ã™ã‚‹UUIDã‚’æ¢ã™
      const log = logs.find(l => l.videoId === id || l.uuid === id || l.hash === hash);

      const address = log?.address ?? "(ä½æ‰€ä¸æ˜)";
      const capturedAt = log?.capturedAt ?? "(æ’®å½±æ—¥æ™‚ä¸æ˜)";
      const verifyUrl = `verify.html?uuid=${id}`;

      const item = document.createElement("div");
      item.className = "entry";
      item.innerHTML = `
        <div><span class="id">${id}</span></div>
        <div class="hash">hash: ${hash}</div>
        <div class="meta">ğŸ  ${address}</div>
        <div class="meta">ğŸ•“ ${capturedAt}</div>
        <div class="meta">ğŸ”— <a href="${verifyUrl}">verify</a></div>
      `;
      listDiv.appendChild(item);
    }
  } catch (e) {
    console.error(e);
    listDiv.innerHTML = `<span class="fail">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼š</span> ${e}`;
  }
}
fetchLedger();
</script>
</body>
</html>
